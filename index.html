<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã –æ—Å–≤–µ—â–µ–Ω–∏—è</title>
<style>
/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 20px;
    text-align: center;
}

h1 {
    color: #2c3e50;
    font-size: 32px;
    margin-bottom: 30px;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ñ–æ—Ä–º—ã */
.form-container {
    background-color: #fff;
    max-width: 600px;
    margin: 0 auto 30px auto;
    padding: 30px 40px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    text-align: left;
}

/* –ú–µ—Ç–∫–∏ –∏ –ø–æ–ª—è */
label {
    display: block;
    font-weight: 600;
    margin-top: 15px;
    margin-bottom: 5px;
}

input[type="number"], select, input[type="text"] {
    width: 100%;
    max-width: 200px;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: 0.2s;
}

input[type="number"]:focus, select:focus, input[type="text"]:focus {
    border-color: #2980b9;
    box-shadow: 0 0 6px rgba(41, 128, 185,0.3);
    outline: none;
}

/* –ö–Ω–æ–ø–∫–∞ */
button {
    padding: 12px 30px;
    font-size: 18px;
    background-color: #c72222;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.3s;
    margin-top: 20px;
}

button:hover {
    background-color: #2980b9;
    transform: scale(1.05);
}

/* –¢–∞–±–ª–∏—Ü—ã */
table {
    border-collapse: collapse;
    margin: 20px auto;
    width: 90%;
    max-width: 900px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
}

th, td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid #ddd;
}

th {
    background-color: #2980b9;
    color: white;
    font-weight: 600;
}

tr:nth-child(even) td {
    background-color: #f9f9f9;
}

tr:hover td {
    background-color: #f1f7ff;
}
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.0"></script>
</head>
<body>

<h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã –æ—Å–≤–µ—â–µ–Ω–∏—è</h1>

<div class="form-container">
<h2>–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

<label>–î–ª–∏–Ω–∞ –ø–æ–º–µ—â–µ–Ω–∏—è a, –º</label>
<input type="number" id="roomLength" value="4">

<label>–®–∏—Ä–∏–Ω–∞ –ø–æ–º–µ—â–µ–Ω–∏—è b, –º</label>
<input type="number" id="roomWidth" value="3">

<label>–í—ã—Å–æ—Ç–∞ –ø–æ–º–µ—â–µ–Ω–∏—è c, –º</label>
<input type="number" id="roomHeight" value="3">

<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∫–æ–Ω</label>
<input type="number" id="windowCount" value="2">

<label>–®–∏—Ä–∏–Ω–∞ –æ–∫–Ω–∞, –º</label>
<input type="number" id="windowWidth" value="1">

<label>–í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞, –º</label>
<input type="number" id="windowHeight" value="1.5">

<label>–í—ã—Å–æ—Ç–∞ –Ω–∏–∑–∞ –æ–∫–Ω–∞ –æ—Ç –ø–æ–ª–∞, –º</label>
<input type="number" id="windowBottomHeight" value="1">

<label>–û—Ç—Å—Ç—É–ø –¥–æ –ø–µ—Ä–≤–æ–≥–æ –æ–∫–Ω–∞, –º</label>
<input type="number" id="windowStart" value="0.5">

<label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –æ–∫–Ω–∞–º–∏, –º</label>
<input type="number" id="windowSpacing" value="0.5">

<label>–ú–æ—â–Ω–æ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∞ P—É—Å—Ç, –í—Ç</label>
<input type="number" id="luminairePower" value="40">

<label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤</label>
<input type="number" id="luminaireCount" value="4">

<label>–ù–æ—Ä–º–∏—Ä—É–µ–º–∞—è –æ—Å–≤–µ—â–µ–Ω–Ω–æ—Å—Ç—å E–Ω–æ—Ä–º, –ª–∫</label>
<input type="number" id="normIlluminance" value="500">

<label>–í—ã—Å–æ—Ç–∞ —Ä–∞–±–æ—á–µ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏, –º</label>
<input type="number" id="workPlaneHeight" value="0.8">

<label>–¶–µ–Ω–∞ 1 –∫–í—Ç¬∑—á —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏, —Ä—É–±</label>
<input type="number" id="electricityPrice" value="5" step="0.5">

<label>–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è (—á–∞—Å, 0‚Äì23)</label>
<input type="number" id="workStartHour" value="8" step="1" min="0" max="23">

<label>–ö–æ–Ω–µ—Ü —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è (—á–∞—Å, 1‚Äì24)</label>
<input type="number" id="workEndHour" value="17" step="1" min="1" max="24">

<label>–ì–æ—Ä–æ–¥</label>
<input type="text" id="city" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞">
<button onclick="loadCityCoordinates()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞</button>

<button onclick="run()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
</div>

<hr>

<h2>–í–∏–¥ —Å–≤–µ—Ä—Ö—É (–ø–ª–∞–Ω–æ–≤—ã–µ —É–≥–ª—ã)</h2>
<canvas id="topView" width="700" height="450"></canvas>

<h2>–í–∏–¥ —Å–±–æ–∫—É (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —É–≥–ª—ã)</h2>
<canvas id="sideView" width="700" height="450"></canvas>

<h2>–¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—á—ë—Ç–∞ –ö–ï–û</h2>
<div id="keoTable"></div>

<h2>–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –ø–æ —Ä–∞—Å—á–µ—Ç–Ω—ã–º —Ç–æ—á–∫–∞–º</h2>
<div id="energyTable"></div>

<h2>–ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏–∏</h2>
<details id="yearlyEnergyDetails">
  <summary>–ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤ (–∫–ª–∏–∫ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è)</summary>
  <div id="yearlyTableContainer" style="margin-top:10px;"></div>
</details>
<!-- –ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–æ—Ç–¥–µ–ª—å–Ω–æ) -->
<div id="yearlySummaryContainer" style="margin-top:15px;"></div>

<h2>–ì–æ–¥–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Å ADL System</h2>
<canvas id="yearlyChart" width="900" height="400"></canvas>

<!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è NASA -->
<h2>–î–∞–Ω–Ω—ã–µ NASA (–ø–æ—á–∞—Å–æ–≤–∞—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å)</h2>
<div id="nasaTableContainer"></div>
<button onclick="showNASATable()">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 48 —á–∞—Å–æ–≤</button>
<button onclick="downloadNASAData()">–°–∫–∞—á–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ NASA CSV</button>

<div id="loadingOverlay" style="
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.4);
    z-index:9999;
    align-items:center;
    justify-content:center;
">
    <div style="
        background:white;
        padding:30px 50px;
        border-radius:12px;
        font-size:18px;
        font-weight:600;
        box-shadow:0 10px 25px rgba(0,0,0,0.2);
    ">
        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶ –ü–æ–¥–æ–∂–¥–∏—Ç–µ
    </div>
</div>
<script>
let nasaData=[];
function showLoading(){
    document.getElementById("loadingOverlay").style.display = "flex";
}

function hideLoading(){
    document.getElementById("loadingOverlay").style.display = "none";
}
// ---------- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≥–æ—Ä–æ–¥–∞ ----------
async function loadCityCoordinates(){
    const city = document.getElementById("city").value.trim();
    if(!city){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞"); return; }

    showLoading(); // üî• –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ

    try{
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
        const response = await fetch(url);
        const data = await response.json();

        if(data.length===0){ 
            hideLoading();
            alert("–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"); 
            return; 
        }

        const lat=parseFloat(data[0].lat);
        const lon=parseFloat(data[0].lon);

        await loadNasaHourlyData(lat, lon, 2019);

        hideLoading(); // üî• —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ

        alert(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ ${city}: —à–∏—Ä–æ—Ç–∞ ${lat}, –¥–æ–ª–≥–æ—Ç–∞ ${lon}\n–î–∞–Ω–Ω—ã–µ NASA –∑–∞ 2019 –≥–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (8760 —á–∞—Å–æ–≤)`);

    }catch(e){
        hideLoading();
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≥–æ—Ä–æ–¥–∞");
        console.error(e);
    }
}

// ---------- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—á–∞—Å–æ–≤–æ–π NASA ----------
async function loadNasaHourlyData(lat, lon, year=2019){
    const start=`${year}0101`;
    const end=`${year}1231`;
    const url=`https://power.larc.nasa.gov/api/temporal/hourly/point?parameters=ALLSKY_SFC_SW_DWN&community=RE&longitude=${lon}&latitude=${lat}&start=${start}&end=${end}&format=JSON`;
    try{
        const response=await fetch(url);
        const data=await response.json();
        if(!data.properties || !data.properties.parameter || !data.properties.parameter.ALLSKY_SFC_SW_DWN){
            alert(`–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö NASA –∑–∞ ${year} –≥–æ–¥`);
            return;
        }

        // 1Ô∏è‚É£ –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ W/m¬≤
        let wm2 = Object.values(data.properties.parameter.ALLSKY_SFC_SW_DWN);

        // 2Ô∏è‚É£ –ü–µ—Ä–µ–≤–æ–¥ –≤ –ª—é–∫—Å—ã (~115 –ª–∫ –Ω–∞ 1 –í—Ç/–º¬≤)
        let lux = wm2.map(v => v * 115);

        // 3Ô∏è‚É£ –ü–ª–∞–≤–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –Ω—É–ª–µ–π)
        for(let i=1;i<lux.length-1;i++){
            if(lux[i] === 0 && lux[i-1]>0 && lux[i+1]>0){
                lux[i] = (lux[i-1]+lux[i+1])/2;
            }
        }

        nasaData = lux;
        if(nasaData.length!==8760) alert("–í–Ω–∏–º–∞–Ω–∏–µ: –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–µ 8760 —á–∞—Å–æ–≤, –∞ "+nasaData.length);
        console.log("NASA hourly data –∑–∞–≥—Ä—É–∂–µ–Ω–∞", nasaData.length);

    }catch(e){ alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö NASA"); console.error(e);}
}

// ---------- –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 48 —á–∞—Å–æ–≤ NASA ----------
function showNASATable(){
    if(nasaData.length===0){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö NASA"); return; }
    const container = document.getElementById("nasaTableContainer");
    let html = `<table>
        <tr><th>–ß–∞—Å</th><th>–û—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å, –ª–∫</th></tr>`;
    for(let i=0;i<Math.min(48,nasaData.length);i++){
        html += `<tr><td>${i+1}</td><td>${nasaData[i].toFixed(0)}</td></tr>`;
    }
    html += "</table>";
    container.innerHTML = html;
}

// ---------- –°–∫–∞—á–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ NASA –≤ CSV ----------
function downloadNASAData(){
    if(nasaData.length===0){ alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö NASA"); return; }
    let csvContent = "data:text/csv;charset=utf-8,Hour,Illuminance_lux\n";
    nasaData.forEach((v,idx)=>{
        csvContent += `${idx+1},${v.toFixed(0)}\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href",encodedUri);
    link.setAttribute("download","NASA_hourly_data_2019_lux.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
// ---------- RUN ----------
let topAngles=[], sideAnglesByRow=[];
function run(){
    // –î–ª—è —Ç–µ—Å—Ç–∞: –µ—Å–ª–∏ NASA –Ω–µ—Ç, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º 500 –ª–∫
    if(nasaData.length!==8760){ nasaData = Array(8760).fill(500); console.log("–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ NASA"); }

    const data={
        room:{length:+roomLength.value,width:+roomWidth.value,height:+roomHeight.value},
        windows:{count:+windowCount.value,width:+windowWidth.value,height:+windowHeight.value,bottom:+windowBottomHeight.value,start:+windowStart.value,spacing:+windowSpacing.value},
        lighting:{count:+luminaireCount.value},
        workPlane:{height:+workPlaneHeight.value},
        normIlluminance:+normIlluminance.value,
        luminairePower:+luminairePower.value,
        workStartHour:+workStartHour.value,
        workEndHour:+workEndHour.value,
        electricityPrice:+electricityPrice.value
    };

    topAngles = drawTopView(data);
    sideAnglesByRow = drawSideView(data);
    buildKeoTable(data);
    buildYearEnergyTable(data);
}


// ---------- –í–ò–î –°–í–ï–†–•–£ ----------
function drawTopView(data){
    const canvas=document.getElementById("topView"), ctx=canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const s=90, ox=60, oy=60; ctx.strokeRect(ox,oy,data.room.length*s,data.room.width*s);
    let windows=[];
    for(let i=0;i<data.windows.count;i++){
        const xA=ox+(data.windows.start+i*(data.windows.width+data.windows.spacing))*s;
        const xB=xA+data.windows.width*s;
        ctx.fillStyle="lightblue"; ctx.fillRect(xA,oy-8,data.windows.width*s,8);
        windows.push({A:{x:xA,y:oy},B:{x:xB,y:oy}});
    }
    const cols=2, rows=Math.ceil(data.lighting.count/cols);
    let angles=[], idx=0;
    for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ if(idx>=data.lighting.count) break;
        const P={x:ox+(c+1)*data.room.length*s/(cols+1),y:oy+(r+1)*data.room.width*s/(rows+1)};
        ctx.fillStyle="green"; ctx.beginPath(); ctx.arc(P.x,P.y,5,0,Math.PI*2); ctx.fill(); ctx.fillText("P"+(idx+1),P.x-6,P.y-10);
        let a=[]; windows.forEach((w,j)=>{
            ctx.strokeStyle="red"; ctx.beginPath(); ctx.moveTo(P.x,P.y); ctx.lineTo(w.A.x,w.A.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(P.x,P.y); ctx.lineTo(w.B.x,w.B.y); ctx.stroke();
            const PA=Math.hypot(P.x-w.A.x,P.y-w.A.y), PB=Math.hypot(P.x-w.B.x,P.y-w.B.y);
            const AB=Math.hypot(w.B.x-w.A.x,w.B.y-w.A.y);
            const deg=Math.acos((PA*PA+PB*PB-AB*AB)/(2*PA*PB))*180/Math.PI; a.push(deg);
            ctx.fillStyle="red"; ctx.fillText("Œ±="+deg.toFixed(1)+"¬∞",P.x+6,P.y+14+12*j);
        }); angles[idx]=a; idx++;
    }} return angles;
}

// ---------- –í–ò–î –°–ë–û–ö–£ ----------
function drawSideView(data){
    const canvas=document.getElementById("sideView"), ctx=canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const sx=90, sy=90, ox=80, oy=40;
    ctx.strokeRect(ox,oy,data.room.length*sx,data.room.height*sy);
    const Q={x:ox,y:oy+(data.room.height-data.windows.bottom-data.windows.height)*sy};
    const W={x:ox,y:Q.y+data.windows.height*sy};
    ctx.fillStyle="lightblue"; ctx.fillRect(ox,Q.y,18,data.windows.height*sy);
    const rows=Math.ceil(data.lighting.count/2);
    const step=data.room.length*sx/(rows+1); let sideAngles=[];
    for(let r=0;r<rows;r++){
        const x=ox+(r+1)*step;
        const P={x,y:oy+(data.room.height-data.workPlane.height)*sy};
        ctx.fillStyle="green"; ctx.beginPath(); ctx.arc(P.x,P.y,4,0,Math.PI*2); ctx.fill(); ctx.fillText("P"+(r+1),P.x-6,P.y+15);
        ctx.strokeStyle="red"; ctx.beginPath(); ctx.moveTo(P.x,P.y); ctx.lineTo(Q.x,Q.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(P.x,P.y); ctx.lineTo(W.x,W.y); ctx.stroke();
        const PQ=Math.hypot(P.x-Q.x,P.y-Q.y), PW=Math.hypot(P.x-W.x,P.y-W.y), QW=Math.hypot(Q.x-W.x,Q.y-W.y);
        const deg=Math.acos((PQ*PQ+PW*PW-QW*QW)/(2*PQ*PW))*180/Math.PI; sideAngles[r]=deg;
        ctx.fillStyle="red"; ctx.fillText("Œ±·µ•="+deg.toFixed(1)+"¬∞",P.x+10,P.y-10);
    } return sideAngles;
}

// ---------- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –ö–ï–û ----------
function calculateKeo(verticalAnglesArray, topAnglesArray){
    const n1 = verticalAnglesArray.reduce((sum,a)=>sum+a,0)*0.56;
    const n2 = topAnglesArray.reduce((sum,a)=>sum+a,0)*0.56;
    return 0.01*(n1*n2);
}

// ---------- –¢–ê–ë–õ–ò–¶–ê –ö–ï–û ----------
function buildKeoTable(data){
    const cols=2; let html=`<table><tr><th>–¢–æ—á–∫–∞</th><th>Œ±·µ•, ¬∞</th><th>Œ£Œ±‚Çö, ¬∞</th><th>–ö–ï–û, %</th></tr>`;
    for(let i=0;i<data.lighting.count;i++){
        const row=Math.floor(i/cols);
        const alphaSide=[sideAnglesByRow[row]]; // –º–∞—Å—Å–∏–≤ –¥–ª—è calculateKeo
        const sumTop=topAngles[i].reduce((s,a)=>s+a,0);
        const keo=calculateKeo(alphaSide, topAngles[i]);
        html+=`<tr><td>P${i+1}</td><td>${alphaSide[0].toFixed(1)}</td><td>${sumTop.toFixed(1)}</td><td>${keo.toFixed(3)}</td></tr>`;
    } html+="</table>"; document.getElementById("keoTable").innerHTML=html;
}

function buildYearEnergyTable(data){
    const tableContainer = document.getElementById("yearlyTableContainer");
    const summaryContainer = document.getElementById("yearlySummaryContainer");

    if(!nasaData.length){ 
        tableContainer.innerHTML = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö NASA"; 
        summaryContainer.innerHTML = ""; 
        return; 
    }

    const keoValues = [];
    const cols = 2;
    for(let i=0;i<data.lighting.count;i++){
        const row = Math.floor(i/cols);
        const alphaSide = [sideAnglesByRow[row]||45];
        const topA = topAngles[i]||[45];
        keoValues.push(calculateKeo(alphaSide, topA));
    }
    
  

 // ===== –¢–∞–±–ª–∏—Ü–∞ –ø–æ –¥–Ω—è–º –∏ —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ =====
let dailyWithADL = [];
let dailyWithoutADL = [];

let html = "<table border='1' cellspacing='0' cellpadding='4'><tr><th>–î–µ–Ω—å</th><th>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å ADL, –∫–í—Ç¬∑—á</th><th>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–µ–∑ ADL, –∫–í—Ç¬∑—á</th></tr>";
const minPowerFactor = 0.1;

let totalWithADL = 0;
let totalWithoutADL = 0;

for(let day=1; day<=365; day++){
    let dayWhWith = 0;
    let dayWhWithout = 0;

    for(let hour = data.workStartHour; hour < data.workEndHour; hour++){
        const idx = (day-1)*24 + (hour-1);
        const Eext = nasaData[idx] || 0;

        for(let i=0;i<data.lighting.count;i++){
            // —Å ADL
            let PfactWith;
            if(Eext <=0){
                PfactWith = data.luminairePower;
            } else {
                const requiredFraction = (data.normIlluminance - Eext*keoValues[i]/100)/data.normIlluminance;
                PfactWith = data.luminairePower * Math.max(minPowerFactor, requiredFraction);
            }
            dayWhWith += PfactWith;

            // –±–µ–∑ ADL
            dayWhWithout += data.luminairePower;
        }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É –¥–Ω—é –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    dailyWithADL.push(dayWhWith/1000);      // –∫–í—Ç¬∑—á
    dailyWithoutADL.push(dayWhWithout/1000);

    totalWithADL += dayWhWith;
    totalWithoutADL += dayWhWithout;

    html += `<tr><td>${day}</td><td>${(dayWhWith/1000).toFixed(3)}</td><td>${(dayWhWithout/1000).toFixed(3)}</td></tr>`;
}

html += "</table>";
tableContainer.innerHTML = html;

    // ===== –ò—Ç–æ–≥–∏ (–æ—Ç–¥–µ–ª—å–Ω–æ) =====
    const yearlyCostWith = (totalWithADL/1000) * data.electricityPrice;
    const yearlyCostWithout = (totalWithoutADL/1000) * data.electricityPrice;
    const savingsPercent = ((yearlyCostWithout - yearlyCostWith)/yearlyCostWithout)*100;

    summaryContainer.innerHTML = `
        <div style="padding:10px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9;">
            <p><b>–ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å ADL System:</b> ${(totalWithADL/1000).toFixed(2)} –∫–í—Ç¬∑—á</p>
            <p><b>–ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–µ–∑ ADL System:</b> ${(totalWithoutADL/1000).toFixed(2)} –∫–í—Ç¬∑—á</p>
            <p><b>–ì–æ–¥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å ADL System:</b> ${yearlyCostWith.toFixed(2)} —Ä—É–±</p>
            <p><b>–ì–æ–¥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑ ADL System:</b> ${yearlyCostWithout.toFixed(2)} —Ä—É–±</p>
            <p><b>–í—ã–≥–æ–¥–∞:</b> ${savingsPercent.toFixed(1)}%</p>
        </div>
    `;
    // ===== –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ –ø–æ–¥–ø–∏—Å—è–º–∏ –º–µ—Å—è—Ü–µ–≤ =====
const ctx = document.getElementById('yearlyChart').getContext('2d');

// –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –≥–æ–¥–∞
const days = Array.from({length:365}, (_,i)=>i+1);

// –î–Ω–∏ –Ω–∞—á–∞–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ (–Ω–µ –≤–∏—Å–æ–∫–æ—Å–Ω—ã–π –≥–æ–¥)
const daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];
let monthStartDays = [];
let counter = 1;
for(let i=0; i<12; i++){
    monthStartDays.push(counter);
    counter += daysInMonth[i];
}
const monthLabels = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];

// –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫ –Ω–∞ –æ—Å–∏ X
const xLabels = {};
monthStartDays.forEach((day, idx) => {
    xLabels[day] = monthLabels[idx];
});

new Chart(ctx,{
    type:'line',
    data:{
        labels: days,
        datasets:[
            {
                label: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å ADL, –∫–í—Ç¬∑—á',
                data: dailyWithADL,
                borderColor:'rgba(75,192,192,1)',
                backgroundColor:'rgba(135,206,250,0.2)',
                fill:true,
                tension:0.2,
                pointRadius:2,
                pointHoverRadius:4
            },
            {
                label: '–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –±–µ–∑ ADL, –∫–í—Ç¬∑—á',
                data: dailyWithoutADL,
                borderColor:'rgba(192,75,75,1)',
                backgroundColor:'rgba(255,200,200,0.2)',
                fill:true,
                tension:0.2,
                pointRadius:2,
                pointHoverRadius:4
            }
        ]
    },
    options:{
        responsive:true,
        plugins:{
            legend:{display:true},
            title:{display:true,text:'–ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤ –ø–æ –¥–Ω—è–º (–∫–í—Ç¬∑—á)'}
        },
        scales:{
            x:{ 
                title:{display:true,text:'–ú–µ—Å—è—Ü'},
                ticks:{
                    callback: function(value,index){
                        // –µ—Å–ª–∏ –¥–µ–Ω—å ‚Äî –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å—å, –∏–Ω–∞—á–µ –ø—É—Å—Ç–æ
                        return xLabels[this.getLabelForValue(value)] || '';
                    },
                    maxRotation:0,
                    autoSkip:false
                }
            },
            y:{ title:{display:true,text:'–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –∫–í—Ç¬∑—á'} }
        }
    }
});
}

</script>

</body>
</html>